# 02. 매매 및 청산 로직 (Execution & Exit)

## 1. 주문 상태 관리 (State Machine)

봇은 각 슬롯(Slot)별로 상태를 관리하며 매매를 진행합니다.

1.  **SEARCHING**: 새로운 타겟을 찾습니다. (최대 3개 슬롯까지 운영)
2.  **BUY_WAIT**: 지정가 매수 주문을 걸고 체결을 대기합니다. (최대 15분)
    *   체결 시 -> `HOLDING`
    *   타임아웃 시 -> 주문 취소 후 `SEARCHING`
3.  **HOLDING**: 매수 체결 완료. 잔고를 모니터링하며 청산 조건을 체크합니다.

## 2. 청산 전략 (Exit Strategy)

진입과 동시에 **4중 방어막**을 가동하여 수익은 길게, 손실은 짧게 가져갑니다.

### A. 전고점 지정가 매도 (Profit Limit)
매수 체결 즉시, **(매수가)와 (최근 3시간 최고가)의 50% 지점**에 매도 지정가 주문을 미리 걸어둡니다.
욕심을 줄이고 확실한 익절을 위해 전고점보다 낮은 위치에서 이익을 확장합니다.
단, 50% 지점이 현재가와 너무 가까우면(+1.0% 미만), 최소 +1.0% 목표가로 설정합니다.

### B. 트레일링 스탑 (Trailing Stop)
*   **1차 진입(물타기 전) 상태에서만 동작**합니다. (물타기 후에는 지정가 매도에 집중하여 안전 탈출 우선)
*   목표 수익률(+1.2%)에 도달하면 발동합니다.
*   이후 고점을 계속 갱신하다가, **고점 대비 -0.5% 하락**하면 시장가로 전량 매도합니다.
*   확인 대기 시간: **1초** (급락 시 즉시 체결)

### C. 본절 보호 (Break-even Stop)
*   수익률이 **+0.7%**를 넘기는 순간 동작합니다.
*   손절 라인(Stop Loss)을 진입가보다 높은 **+0.1%**로 상향 조정합니다.
*   이후 가격이 다시 떨어져도 절대 마이너스를 보지 않고 익절합니다.

### D. 손절매 (Stop Loss)
*   진입가(또는 물타기 후 평단가) 대비 **-5.0%** 손실 시 즉시 시장가 매도.
*   대기 시간: **1초** (즉각 반응)

## 3. 물타기 (Add-Buy)
*   다음 조건 만족 시 1회 추가 매수(Watering)를 진행합니다. (설정값 예시)
    *   수익률 **-3.0%** 도달
    *   최대 1회 제한
*   **동작 방식:**
    1.  시장가로 추가 매수하여 평단가를 낮춥니다.
    2.  기존의 익절(Sell Limit) 주문을 취소하고, **새로운 평단가 기준 +1.0% (또는 전고점 반영비)** 가격에 다시 매도 주문을 겁니다.
    3.  **중요:** 물타기 이후에는 **트레일링 스탑 동작을 중지**하고, 지정가 매도 체결을 기다립니다. (잦은 흔들림에 의한 손실 방지)

## 4. 시스템 최적화 (Optimization)
*   **고속 루프:** 0.2초마다 시세를 확인하여 시장 변동에 실시간 대응합니다.
*   **API 최적화:** 모든 보유 종목의 현재가를 1회 API 호출(Batch Call)로 조회하여, 호출 횟수 제한(Rate Limit)을 준수하면서도 반응 속도를 극대화했습니다.
