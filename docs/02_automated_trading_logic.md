# 02. 매매 및 청산 로직 (Execution & Exit)

## 1. 주문 상태 관리 (State Machine)

봇은 각 슬롯(Slot)별로 상태를 관리하며 매매를 진행합니다.

1.  **SEARCHING**: 새로운 타겟을 찾습니다. (최대 3개 슬롯까지 운영)
2.  **BUY_WAIT**: 지정가 매수 주문을 걸고 체결을 대기합니다. (최대 15분)
    *   체결 시 -> `HOLDING`
    *   타임아웃 시 -> 주문 취소 후 `SEARCHING`
3.  **HOLDING**: 매수 체결 완료. 잔고를 모니터링하며 청산 조건을 체크합니다.

## 2. 청산 전략 (Exit Strategy)

진입과 동시에 **4중 방어막**을 가동하여 수익은 길게, 손실은 짧게 가져갑니다.

### A. 전고점 지정가 매도 (Profit Limit)
*   매수 체결 즉시, **최근 3시간 최고가(High)**에 **매도 지정가 주문**을 미리 걸어둡니다.
*   갑작스런 슈팅(Shooting)이 나올 때 고점에서 자동으로 팔리도록 합니다.
*   단, 3시간 최고가가 현재가와 너무 가까우면(+0.5% 미만), 최소 +1.0% 목표가로 설정합니다.

### B. 트레일링 스탑 (Trailing Stop)
*   목표 수익률(**+0.5%**)에 도달하면 발동합니다.
*   이후 고점을 계속 갱신하다가, **고점 대비 -0.2% 하락**하면 시장가로 전량 매도합니다.
*   (예: +3%까지 올랐다가 +2.8%로 떨어지면 매도하여 수익 실현)

### C. 본절 보호 (Break-even Stop)
*   수익률이 **+0.7%**를 넘기는 순간 동작합니다.
*   손절 라인(Stop Loss)을 진입가보다 살짝 높은 **+0.05%**로 상향 조정합니다.
*   이후 가격이 다시 떨어져도 수수료 정도만 내고 원금을 지킵니다. ("이기는 싸움만 한다")

### D. 손절매 (Stop Loss)
*   어떤 경우라도 진입가 대비 **-2.0%** 손실이 발생하면 **즉시 시장가 매도**합니다.
*   급락 방어(Sudden Drop): 5분봉 1개에서 -1.0% 이상 급락이 나와도 매도합니다.

## 3. 물타기 (Add-Buy)
*   기본적으로 사용하지 않으나, 설정에 따라 다음 조건 만족 시 1회 추가 매수합니다.
    *   손실률 -1.5% 도달
    *   **AND** 진입 시점 15분 경과
    *   **AND** 추세 점수(Score)가 여전히 20점 이상일 때 (추세가 살아있을 때만)
    *   조건 만족 시 동일 금액만큼 시장가 추가 매수(물타기) 후 평단가 개선.
