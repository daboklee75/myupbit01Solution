# 자동 매매 로직 (Automated Trading Logic)

이 문서는 `src/myupbit01/trader.py`에 구현된 자동 매매 시스템의 상세 로직을 설명합니다.

## 1. 개요 (Overview)
- **목표**: 상승 추세에 있는 코인을 포착하여 단타 매매를 수행하고, 리스크를 관리하며 수익을 극대화합니다.
- **특징**:
  - 설정된 **최대 슬롯(`MAX_SLOTS`)** 만큼 동시에 여러 종목을 거래합니다 (Multi-Slot).
  - 매매 상태는 `trade_state.json` 파일에 실시간으로 저장되어, 프로그램 재시작 시에도 로직이 유지됩니다.
  - API 요청 제한을 고려하여 설계되었습니다.

## 2. 진입 전략 (Entry Strategy)
- **조건**: 현재 보유 중인 종목 수가 `MAX_SLOTS` 미만일 때만 새로운 종목을 탐색합니다.
- **대상 선정**:
  - `trend.py`의 `scan_trends(strict=True)` 조건을 만족하는 종목 (정배열 + SMA5 우상향).
  - 현재 보유 중인 종목은 제외합니다.
  - 여러 종목이 검색될 경우, **이격도(5일/20일 SMA 괴리율)가 가장 낮은** 종목을 최우선으로 선정합니다. (이동평균선 지지 근처 매수).
- **매수 주문**:
  - **가격**: 현재가보다 **1호가(Tick) 아래** 지정가 매수.
  - **금액**: `.env` 설정의 `TRADE_AMOUNT` (기본 10,000원).
- **타임아웃 (Timeout)**:
  - 주문 후 **5분** 내에 체결되지 않으면 주문을 취소하고, 다시 탐색 단계로 돌아갑니다.

## 3. 시장 감시 (Market Circuit Breaker)
전체 시장이 급락할 때는 매수를 보류(Pause)합니다.

- **비트코인 급락 필터**:
  - **조건**: 비트코인(KRW-BTC) 현재 1분봉이 **-0.7% 이상** 급락 중일 때.
  - **동작**: 신규 진입 탐색(`WAITING`)을 일시 중단하고 10초 대기 후 재확인합니다.

## 4. 방어 전략 (Defense Strategy)
보유 중(`HOLDING`)일 때 다음 조건이 발생하면 **시장가(Market Price)**로 전량 매도합니다.

1.  **급락 방어 (Sudden Drop Protection)**:
    - **조건**: 현재가가 **5분봉 시가(Open)** 대비 **-1% 이상** 하락 시.
    - **주기**: API 과부하 방지를 위해 **1분에 한 번씩** 체크합니다.
2.  **손절매 (Stop Loss)**:
    - **조건**: 현재 수익률이 **-2% 이하**로 떨어질 경우 즉시 매도.

## 4. 익절 및 트레일링 스탑 (Profit Taking & Trailing Stop)
수익을 길게 가져가면서도 급락 시 이익을 보존하기 위한 로직입니다.

- **감시 시작 조건**: 수익률이 **+0.5%** 이상 도달했을 때 활성화됩니다.
- **최고가 갱신**: 진입 이후(또는 추매 이후) 현재가가 전고점(`highest_price`)을 넘으면 계속 갱신합니다.
- **매도 조건**: 현재가가 전고점 대비 **-0.2%** 이상 하락하면 시장가 매도합니다.
  - 예: +1.0%까지 올랐다가 +0.8%로 떨어지면 매도.

## 5. 탈출 및 추매 전략 (Exit & Add-Buy Strategy)
매수 후 가격이 오르지 않고 지지부진하거나 약손실 상태일 때 평단가를 낮춰 탈출을 시도합니다.

- **조건**:
  1. 진입 후 **30분** 경과.
  2. 현재 수익률이 **0% 미만** (손실 중).
  3. 해당 종목에 대해 아직 추매를 하지 않음 (1회 제한).
- **실행**:
  - 1회 분(*초기 투자금과 동일*)을 **시장가**로 추가 매수합니다.
- **후처리**:
  - 평균 매수가(평단가)를 재계산합니다.
  - `highest_price`를 현재가로 리셋하여 트레일링 스탑 로직을 다시 시작합니다.

## 6. 설정 및 환경 변수
- `TRADE_AMOUNT`: 1회 거래 금액 (원화). `.env` 파일에서 수정 가능.
- `MAX_SLOTS`: 동시 거래 가능한 최대 종목 수 (기본 3).
- `trade_state.json`: 현재 프로그램의 실행 상태 및 보유 코인 정보를 담고 있는 파일. (수동 수정 금지)
