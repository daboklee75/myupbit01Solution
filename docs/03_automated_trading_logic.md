# 자동 매매 로직 (Automated Trading Logic)

이 문서는 `src/myupbit01/trader.py` 및 `src/myupbit01/trend.py`에 구현된 고도화된 자동 매매 시스템의 상세 로직을 설명합니다.

## 1. 개요 (Overview)
- **목표**: 실시간 시장 주도주를 포착하여 단타 매매를 수행하고, 리스크를 관리하며 수익을 극대화합니다.
- **특징**:
  - **동적 유니버스**: 고정된 기준이 아닌, 실시간 거래대금 상위 종목을 대상으로 합니다.
  - **종합 스코어링 시스템**: 단순 추세뿐만 아니라 변동성, 거래량 급증, 호가창 상태 등을 종합적으로 점수화하여 판단합니다.
  - **웹 대시보드 연동**: 실시간 상태 모니터링 및 설정 변경(`trader_config.json`)이 가능합니다.

## 2. 종목 선정 및 진입 (Selection & Entry)
### A. 유니버스 필터링 (Dynamic Universe)
- **거래대금 Top 30**: 업비트 원화 마켓 중 최근 24시간 거래대금 상위 30개 종목을 실시간으로 선정합니다.

### B. 종합 스코어링 (Entry Scoring System)
선정된 30개 종목에 대해 다음 항목들을 분석하여 점수를 부여합니다. (최소 진입 점수: 20점)

| 항목 | 조건 | 점수 | 의미 |
|---|---|---|---|
| **Trend Alignment** | SMA 5 > 20 > 60 (정배열) | +10 | 강력한 상승 추세 |
| | SMA 5 > 20 (기본 정배열) | +5 | 단기 상승 추세 |
| **Trend Strength** | SMA 5 기울기 상승 (Current > Prev) | +10 | 상승 가속화 |
| **Indicator** | ADX > 25 (강한 추세) | +3 | 추세장 확인 |
| | ADX 상승 중 | +2 | 추세 강화 중 |
| **Volatility** | 5분봉 표준편차 증가 | +5 | 변동성 확대 (시세 분출 임박) |
| **Volume Spike** | **최근 1시간 거래량 > 24시간 평균의 2배** | **+10** | **수급 폭발 (가장 중요)** |
| **Market Pressure** | 매도 잔량 > 매수 잔량 (Upward Pressure) | +5 | 상승 돌파 시도 |
| **Trade Strength** | 최근 체결 중 매수 비중 > 60% | +10 | 매수세 우위 |

**선정 기준**: 보유 중이 아니며 쿨타임이 없는 종목 중 **점수가 가장 높은 종목** 1개를 진입 대상으로 선정합니다.

### C. 매수 실행
- **가격**: 현재가보다 1호가 아래 (Limit Order).
- **타임아웃**: 5분 내 미체결 시 취소.

## 3. 매도 및 청산 (Exit Strategy)
### A. 방어 로직 (Defense)
- **급락 감지**: 5분봉 시가 대비 **-1.0%** 이상 급락 시 즉시 시장가 매도.
- **손절매 (Stop Loss)**: 설정된 `STOP_LOSS` (기본 -2.0%) 도달 시 시장가 매도.

### B. 수익 실현 (Profit Taking)
- **트레일링 스탑 (Trailing Stop)**:
  - 수익률이 `PROFIT_TARGET` (기본 0.5%) 이상 도달하면 작동 시작.
  - 이후 `highest_price`를 지속 갱신.
  - 고점 대비 `TRAILING_CALLBACK` (기본 0.2%) 하락 시 이익 실현 매도.
  - 예: +1.5%까지 상승 후 +1.3%로 하락 시 매도 처리.

### C. 시간 및 수동 청산
- **Panic Sell**: 사용자가 웹 대시보드에서 명령 시 즉시 시장가 매도.
- **추매 전략 (Watering)**: 진입 30분 후 손실 상태(-0.x%)이면 1회 추가 매수(물타기)하여 평단가를 낮춤.

## 4. 기타 시스템 (System Features)
- **쿨타임 (Cooldown)**: 매도한 종목은 설정된 시간(기본 60분) 동안 재진입 금지.
- **상시 스캔**: 슬롯이 꽉 차 있어도 대시보드 표시를 위해 시장 스캔은 계속 수행됩니다.
- **동적 설정**: `trader_config.json`을 통해 `TRADE_AMOUNT`, `MAX_SLOTS` 등을 봇 재시작 없이 변경 가능합니다.
